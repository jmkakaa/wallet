<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ö–æ—à–µ–ª—ë–∫</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* ===== 1) –ë–ê–ó–ê –ò –¶–í–ï–¢–ê ===== */
    :root{
      --bg: #0f1b24;
      --panel: #0a0f14;
      --text: #ffffff;
      --muted: #a6b3bf;
      --primary: #2f8cff;
      --primary-weak: #e8f0ff;
      --success: #12b76a;
      --danger: #ef4444;
      --card-grad-1:#25b4ff; --card-grad-2:#24d39e;
      --radius-xl: 20px;
      --radius-lg: 16px;
      --radius-md: 14px;
      --shadow: 0 8px 24px rgba(0,0,0,.25);
      --maxw: 480px; /* —à–∏—Ä–∏–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
      --tabbar-h: 72px;
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; }
    html{ height:100%; }
    body{
      min-height:100%;
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;       /* —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
      max-width:100%;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      font: 500 16px/1.45 system-ui, -apple-system, "SF Pro Text",
            Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    img,svg,canvas,video{ display:block; max-width:100%; height:auto; }

    /* ===== 2) –ö–û–ù–¢–ï–ô–ù–ï–† –ò –°–ï–¢–ö–ê ===== */
    .app{
      width:100%;
      max-width:var(--maxw);
      margin:0 auto;
      min-height:100dvh;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .content{
      flex:1 1 auto;
      padding-bottom: calc(var(--tabbar-h) + env(safe-area-inset-bottom, 0px) + 12px);
    }

    /* ===== 3) –ö–ê–†–¢–û–ß–ö–ò ===== */
    .card{
      width:100%;
      border-radius:var(--radius-xl);
      background:linear-gradient(135deg,var(--card-grad-1),var(--card-grad-2));
      padding:20px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card__title{
      font: 800 clamp(20px,3.8vw,28px)/1.15 system-ui, -apple-system, "SF Pro Display", Segoe UI, Roboto, Arial;
      letter-spacing:.2px;
    }
    .id{
      margin-top:6px;
      color:#e8f2fb;
      font-weight:600;
      opacity:.9;
    }
    .balance{
      margin:18px 0 20px;
      font: 900 clamp(34px,8vw,44px)/1.05 system-ui, -apple-system, "SF Pro Display", Segoe UI, Roboto, Arial;
      letter-spacing:.5px;
    }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      height:52px; padding:0 18px; width:100%;
      border:0; border-radius:var(--radius-md);
      font: 800 16px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      cursor:pointer;
      user-select:none; -webkit-tap-highlight-color:transparent;
    }
    .btn--primary{ background:var(--primary); color:#fff; }
    .btn--ghost{ background:#fff; color:#0a0f14; }

    .panel{
      background:var(--panel);
      border-radius:var(--radius-xl);
      padding:16px;
      box-shadow:var(--shadow);
    }
    .panel__title{
      font: 800 20px/1.2 system-ui, -apple-system, "SF Pro Display", Segoe UI, Roboto;
      margin:0 0 12px;
    }
    .muted{ color:var(--muted); }

    /* ===== 4) –¢–ê–ë–ë–ê–† ===== */
    .tabbar{
      position:fixed; left:0; right:0; bottom:0;
      height:var(--tabbar-h);
      background:#fff;
      border-top-left-radius:16px; border-top-right-radius:16px;
      padding:8px 12px calc(8px + env(safe-area-inset-bottom,0px));
      display:flex; justify-content:center; align-items:center;
      box-shadow: 0 -8px 24px rgba(0,0,0,.28);
      z-index:100;
      width:100%; max-width:100%;
    }
    .tabbar__inner{
      width:100%; max-width:var(--maxw);
      display:grid; grid-template-columns:repeat(3,1fr); gap:8px;
    }
    .tab{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      height:56px; border-radius:12px;
      color:#5b6b7a; text-decoration:none; font-weight:800; font-size:13px;
      gap:4px;
    }
    .tab--active{ color:#111; background:#f4f6f8; }

    /* ===== 5) –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–ò –≠–ö–†–ê–ù–û–í ===== */
    .screen{ display:none; }
    .screen--active{ display:block; }

    /* ===== 6) –§–û–†–ú–ê –ü–ï–†–ï–í–û–î–ê ===== */
    .form{ display:grid; gap:12px; }
    .field label{
      display:block; margin:0 0 6px; font-weight:800; color:#dfe7ef;
    }
    .input{
      width:100%; height:48px; border-radius:12px; border:1px solid #1f2a33;
      background:#0f1620; color:#fff; padding:0 14px; font-weight:700;
      outline:none;
    }
    .input::placeholder{ color:#8aa0b3; }
    .help{ font-size:12px; color:#8aa0b3; }

    /* ===== 7) –°–ü–ò–°–û–ö –ò–°–¢–û–†–ò–ò ===== */
    .history{ display:grid; gap:10px; }
    .item{
      background:#0f1620; border:1px solid #1f2a33;
      border-radius:14px; padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .pos{ color:var(--success); font-weight:900; }
    .neg{ color:var(--danger);  font-weight:900; }
    .title{ font-weight:800; }

    /* –ó–∞—â–∏—Ç–∞ –æ—Ç ‚Äú–≤—ã–ø–∏—Ä–∞–Ω–∏—è‚Äù —á–µ–≥–æ-–ª–∏–±–æ */
    .card, .panel, .item, .row, .input, .btn { min-width:0; }
  </style>
</head>

<body>
  <div class="app">
    <!-- –ì–õ–ê–í–ù–ê–Ø -->
    <main id="screen-home" class="screen screen--active">
      <section class="card">
        <div class="card__title">–ö–æ—à–µ–ª—ë–∫</div>
        <div id="userId" class="id">ID: ‚Äî</div>
        <div class="balance"><span id="balance">0</span> ‚ÇΩ</div>
        <div class="row">
          <button class="btn btn--primary" id="add100">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          <button class="btn btn--ghost" id="withdraw100">–í—ã–≤–µ—Å—Ç–∏</button>
        </div>
      </section>

      <section class="panel">
        <h3 class="panel__title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <div class="row">
          <button class="btn" id="toTransfer" style="background:#102335;color:#fff;">‚ÜîÔ∏è –ü–µ—Ä–µ–≤–æ–¥</button>
          <button class="btn" id="toHistory" style="background:#102335;color:#fff;">üßæ –ò—Å—Ç–æ—Ä–∏—è</button>
        </div>
      </section>
    </main>

    <!-- –ü–ï–†–ï–í–û–î -->
    <section id="screen-transfer" class="screen">
      <div class="panel">
        <h3 class="panel__title">–ü–µ—Ä–µ–≤–æ–¥</h3>
        <form id="transferForm" class="form" onsubmit="return false;">
          <div class="field">
            <label for="toId">–ö–æ–º—É (Telegram user ID)</label>
            <input class="input" id="toId" type="number" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789" />
            <div class="help">–ü–µ—Ä–µ–≤–æ–¥ —Å–∞–º–æ–º—É —Å–µ–±–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</div>
          </div>
          <div class="field">
            <label for="amount">–°—É–º–º–∞ (‚ÇΩ)</label>
            <input class="input" id="amount" type="number" step="0.01" min="0.01" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 100" />
          </div>
          <button class="btn btn--primary" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          <div id="transferMsg" class="help"></div>
        </form>
      </div>
    </section>

    <!-- –ò–°–¢–û–†–ò–Ø -->
    <section id="screen-history" class="screen">
      <div class="panel">
        <h3 class="panel__title">–ò—Å—Ç–æ—Ä–∏—è</h3>
        <div id="history" class="history"></div>
      </div>
    </section>

    <div class="content"></div>
  </div>

  <!-- –¢–ê–ë–ë–ê–† -->
  <nav class="tabbar">
    <div class="tabbar__inner">
      <a href="#home"     class="tab tab--active" data-tab="home">üè† <span>–ì–ª–∞–≤–Ω–∞—è</span></a>
      <a href="#transfer" class="tab"            data-tab="transfer">‚ÜîÔ∏è <span>–ü–µ—Ä–µ–≤–æ–¥</span></a>
      <a href="#history"  class="tab"            data-tab="history">üßæ <span>–ò—Å—Ç–æ—Ä–∏—è</span></a>
    </div>
  </nav>

  <script>
    // ===== –¢–µ–ª–µ–≥—Ä–∞–º Bootstrap =====
    const tg = window.Telegram?.WebApp;
    if (tg) { try { tg.ready(); tg.expand(); } catch(e){} }

    // ===== –£—Ç–∏–ª–∏—Ç—ã =====
    const $ = (sel) => document.querySelector(sel);
    const API = {
      async me(user_id){ const r = await fetch(`/api/me?user_id=${user_id}`); return r.json(); },
      async history(user_id){ const r = await fetch(`/api/history?user_id=${user_id}`); return r.json(); },
      async transfer(from_user_id, to_user_id, amount){
        const r = await fetch(`/api/transfer`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ from_user_id, to_user_id, amount: Number(amount) })
        });
        if(!r.ok){ const err = await r.json().catch(()=>({detail:'–û—à–∏–±–∫–∞'})); throw new Error(err.detail||'–û—à–∏–±–∫–∞'); }
        return r.json();
      }
    };

    function detectUserId(){
      // 1) Telegram Mini App
      const id = tg?.initDataUnsafe?.user?.id;
      if (id) return id;
      // 2) –§–æ–ª–±—ç–∫ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
      const m = location.search.match(/[?&]user_id=(\d+)/);
      return m ? Number(m[1]) : null;
    }

    const state = {
      userId: detectUserId(),
      balance: 0
    };

    // ===== –†–µ–Ω–¥–µ—Ä =====
    async function refreshAll(){
      if(!state.userId){
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å user_id. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ Telegram –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ ?user_id=XXXXX –≤ –∞–¥—Ä–µ—Å.');
        return;
      }
      $("#userId").textContent = `ID: ${state.userId}`;
      await refreshBalance();
      await refreshHistory();
    }

    async function refreshBalance(){
      const data = await API.me(state.userId);
      state.balance = data.balance ?? 0;
      $("#balance").textContent = (Math.round(state.balance*100)/100).toLocaleString('ru-RU');
    }

    async function refreshHistory(){
      const box = $("#history");
      box.innerHTML = '';
      const data = await API.history(state.userId);
      (data.items || []).forEach(it=>{
        const li = document.createElement('div');
        li.className = 'item';
        const amount = Number(it.amount||0);
        li.innerHTML = `
          <div class="title">${it.title||'–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è'}</div>
          <div class="${amount>=0?'pos':'neg'}">${amount>0?'+':''}${amount.toLocaleString('ru-RU')} ‚ÇΩ</div>
        `;
        box.appendChild(li);
      });
      if(!box.children.length){
        const empty = document.createElement('div');
        empty.className='muted';
        empty.style.padding='8px';
        empty.textContent='–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π';
        box.appendChild(empty);
      }
    }

    // ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è =====
    const screens = {
      home: $("#screen-home"),
      transfer: $("#screen-transfer"),
      history: $("#screen-history")
    };
    function setTab(tab){
      document.querySelectorAll('.tab').forEach(el=>{
        el.classList.toggle('tab--active', el.dataset.tab===tab);
      });
      Object.entries(screens).forEach(([k,el])=>{
        el.classList.toggle('screen--active', k===tab);
      });
      if (tab==='history') refreshHistory();
      if (tg) try { tg.HapticFeedback?.impactOccurred('light'); } catch(e){}
    }
    document.querySelectorAll('.tab').forEach(el=>{
      el.addEventListener('click', (e)=>{ e.preventDefault(); setTab(el.dataset.tab); });
    });
    $("#toTransfer").addEventListener('click', ()=> setTab('transfer'));
    $("#toHistory").addEventListener('click',  ()=> setTab('history'));

    // ===== –î–µ–π—Å—Ç–≤–∏—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–π =====
    $("#add100").addEventListener('click', async ()=>{
      try{
        await API.transfer(state.userId, state.userId, 100);
        await refreshAll();
      }catch(err){ alert(err.message||'–û—à–∏–±–∫–∞'); }
    });
    $("#withdraw100").addEventListener('click', async ()=>{
      try{
        await API.transfer(state.userId, state.userId, -100); // –µ—Å–ª–∏ –Ω–∞ –±—ç–∫–µ –∑–∞–ø—Ä–µ—Ç –Ω–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ ‚Äî —É–±–µ—Ä–∏—Ç–µ
        await refreshAll();
      }catch(err){ alert(err.message||'–û—à–∏–±–∫–∞'); }
    });

    // ===== –ü–µ—Ä–µ–≤–æ–¥ =====
    $("#sendBtn").addEventListener('click', async ()=>{
      const toId = Number($("#toId").value.trim());
      const amount = Number($("#amount").value.trim());
      const out = $("#transferMsg");
      out.textContent = '';
      if(!toId || !amount || amount<=0){ out.textContent='–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'; return; }
      try{
        await API.transfer(state.userId, toId, amount);
        out.style.color = '#86efac';
        out.textContent = '‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω';
        $("#amount").value = '';
        await refreshAll();
        if (tg) try { tg.HapticFeedback?.notificationOccurred('success'); } catch(e){}
      }catch(err){
        out.style.color = '#fca5a5';
        out.textContent = '‚ùå ' + (err.message||'–û—à–∏–±–∫–∞');
        if (tg) try { tg.HapticFeedback?.notificationOccurred('error'); } catch(e){}
      }
    });

    // –°—Ç–∞—Ä—Ç
    refreshAll();
  </script>
</body>
</html>
